<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>패션 스타일 추천 실험실</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Inter", "Segoe UI", sans-serif;
      background-color: #f5f6f8;
      color: #1f2937;
      line-height: 1.5;
    }

    body {
      margin: 0;
      background-color: inherit;
      color: inherit;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 48px 24px 64px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: -0.015em;
    }

    header p {
      margin: 0;
      color: #4b5563;
      font-size: 0.98rem;
    }

    .layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    .card {
      background-color: #ffffff;
      border-radius: 14px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.04);
    }

    .card h2 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: -0.01em;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px 20px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #334155;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      min-height: 46px;
      padding: 11px 14px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background-color: #f9fafb;
      font-size: 0.95rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      background-color: #ffffff;
    }

    .actions {
      grid-column: 1 / -1;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 4px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 0.95rem;
      min-width: 120px;
    }

    button[type="submit"] {
      background-color: #2563eb;
      color: #ffffff;
    }

    button.secondary {
      background-color: #e5e7eb;
      color: #1f2937;
    }

    .status {
      min-height: 1.4em;
      font-size: 0.9rem;
      color: #4b5563;
    }

    .status.success { color: #047857; }
    .status.error { color: #b91c1c; }

    details {
      background: #f9fafb;
      border-radius: 10px;
      padding: 12px 14px;
    }

    summary {
      font-weight: 600;
      cursor: pointer;
    }

    pre {
      margin-top: 10px;
      background-color: #0f172a;
      color: #f8fafc;
      padding: 16px;
      border-radius: 10px;
      overflow-x: auto;
      font-size: 0.82rem;
      line-height: 1.55;
      max-height: 420px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 결과 카드 */
    .response-stack {
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-height: 120px;
    }

    .placeholder {
      color: #64748b;
      font-style: italic;
    }

    .profile,
    .recommendation,
    .perfume {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 12px;
      padding: 18px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .profile h3,
    .recommendation h3 {
      margin: 0;
      font-size: 1.05rem;
    }

    dl.profile-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px 16px;
      margin: 0;
    }

    dl.profile-details dt {
      font-weight: 600;
      font-size: 0.82rem;
      color: #475569;
    }

    dl.profile-details dd {
      margin: 0;
      font-size: 0.92rem;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      background: #e2e8f0;
      color: #1f2937;
    }

    .chip.blue { background: #dbeafe; color: #1d4ed8; }
    .chip.green { background: #bbf7d0; color: #166534; }

    .list,
    .meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .list li,
    .meta li {
      display: flex;
      gap: 10px;
      align-items: baseline;
      font-size: 0.92rem;
    }

    .list .label,
    .meta .label {
      min-width: 88px;
      font-weight: 600;
      color: #475569;
      text-transform: capitalize;
    }

    .color-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .swatch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 11px;
      border-radius: 999px;
      background: #e2e8f0;
      font-size: 0.78rem;
    }

    .swatch span {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.25);
    }

    .perfume-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .muted {
      color: #94a3b8;
      font-size: 0.85rem;
    }

    @media (max-width: 720px) {
      main { padding: 36px 20px 48px; }
      .card { padding: 20px; }
      form { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>패션 스타일 추천 실험실</h1>
      <p>입력 스키마를 기반으로 Azure OpenAI 모델에 질의하고, 구조화된 결과를 카드 형태로 확인합니다.</p>
    </header>

    <div class="layout">
      <section class="card">
        <h2>요청 입력</h2>
        <form id="style-form">
          <div class="field">
            <label for="gender">성별</label>
            <select id="gender" name="gender" required>
              <option value="Men">Men</option>
              <option value="Women">Women</option>
              <option value="Unisex">Unisex</option>
            </select>
          </div>

          <div class="field">
            <label for="age">나이</label>
            <input id="age" name="age" type="number" min="10" max="100" required />
          </div>

          <div class="field">
            <label for="industry">직군 (industry)</label>
            <input id="industry" name="industry" type="text" placeholder="예: IT" required />
          </div>

          <div class="field">
            <label for="role">역할 (role)</label>
            <input id="role" name="role" type="text" placeholder="예: Frontend Developer" required />
          </div>

          <div class="field" style="grid-column: span 2;">
            <label for="style_preference">스타일 선호 (콤마로 구분)</label>
            <input id="style_preference" name="style_preference" type="text" placeholder="minimal, casual, street" required />
          </div>

          <div class="field">
            <label for="season">시즌</label>
            <select id="season" name="season">
              <option value="Spring">Spring</option>
              <option value="Summer">Summer</option>
              <option value="Fall">Fall</option>
              <option value="Winter">Winter</option>
              <option value="null">null</option>
            </select>
          </div>

          <div class="field">
            <label for="budget">예산</label>
            <select id="budget" name="budget">
              <option value="$">$</option>
              <option value="$$" selected>$$</option>
              <option value="$$$">$$$</option>
              <option value="null">null</option>
            </select>
          </div>

          <div class="field">
            <label for="need_count">필요 추천 개수</label>
            <input id="need_count" name="need_count" type="number" min="1" max="5" value="2" required />
          </div>

          <div class="actions">
            <button type="submit">추천 받기</button>
            <button type="button" id="prefill" class="secondary">예시 값 채우기</button>
            <button type="button" id="reset" class="secondary">초기화</button>
          </div>
        </form>
        <p class="status" id="status"></p>

        <details>
          <summary>입력 스키마 보기</summary>
          <pre id="input-schema"></pre>
        </details>
      </section>

      <section class="card">
        <h2>모델 응답</h2>
        <div id="response-structured" class="response-stack">
          <p class="placeholder">모델 응답이 준비되면 이 영역에 카드가 표시됩니다.</p>
        </div>
        <details>
          <summary>Raw JSON 보기</summary>
          <pre id="response-json">모델 응답이 준비되면 이곳에 JSON이 표시됩니다.</pre>
        </details>
        <details>
          <summary>출력 스키마 보기</summary>
          <pre id="output-schema"></pre>
        </details>
      </section>
    </div>
  </main>

  <script>
    const form = document.getElementById('style-form');
    const statusEl = document.getElementById('status');
    const responseStructured = document.getElementById('response-structured');
    const responseJson = document.getElementById('response-json');
    const prefillBtn = document.getElementById('prefill');
    const resetBtn = document.getElementById('reset');
    const inputSchemaEl = document.getElementById('input-schema');
    const outputSchemaEl = document.getElementById('output-schema');

    const inputSchemaSample = `{
  "user_profile": {
    "gender": "Men",
    "age": 24,
    "occupation": {
      "industry": "IT",
      "role": "Frontend Developer"
    },
    "style_preference": ["minimal", "casual", "street"]
  },
  "options": {
    "season": "Summer",
    "budget": "$$",
    "need_count": 2
  }
}`;

    const outputSchemaSample = `{
  "profile_echo": {
    "gender": "Men|Women|Unisex",
    "age": 0,
    "industry": "string",
    "role": "string",
    "style_preference": ["string"],
    "season": "Spring|Summer|Fall|Winter|null",
    "budget": "$|$$|$$$|null"
  },
  "recommendations": [
    {
      "outfit": {
        "title": "string",
        "hook_line": "string",
        "dress_code": "casual|smart-casual|business-casual|formal",
        "items": [
          { "category": "top|outer|bottom|shoes|bag|accessory", "name": "string", "color": "string|null" }
        ],
        "style_tags": ["string"],
        "color_palette": ["string"],
        "why": ["string", "string"],
        "season_fit": ["Spring","Summer","Fall","Winter"],
        "budget_range": "$|$$|$$$|null",
        "evidence_doc_ids": ["string"]
      },
      "perfumes": [
        {
          "name": "string",
          "brand": "string|null",
          "accords": ["string"],
          "notes": ["string"],
          "projection": "soft|moderate|strong|null",
          "longevity": "short|moderate|long|null",
          "seasonality": ["Spring","Summer","Fall","Winter"],
          "why_match": ["string", "string"],
          "evidence_doc_ids": ["string"],
          "score": 0.0
        }
      ],
      "score": 0.0
    }
  ],
  "context_used": true,
  "pagination": { "requested": 2, "returned": 2 }
}`;

    inputSchemaEl.textContent = inputSchemaSample;
    outputSchemaEl.textContent = outputSchemaSample;

    const examplePayload = {
      user_profile: {
        gender: 'Men',
        age: 24,
        occupation: {
          industry: 'IT',
          role: 'Frontend Developer',
        },
        style_preference: ['minimal', 'casual', 'street'],
      },
      options: {
        season: 'Summer',
        budget: '$$',
        need_count: 2,
      },
    };

    function parseStylePreference(rawValue) {
      return rawValue
        .split(',')
        .map((item) => item.trim())
        .filter(Boolean);
    }

    function safe(value, fallback = '-') {
      if (value === null || value === undefined || value === '') return fallback;
      return value;
    }

    function createElement(tag, className, text) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      if (text) el.textContent = text;
      return el;
    }

    function renderProfile(profile) {
      if (!profile) return null;

      const section = createElement('section', 'profile');
      section.appendChild(createElement('h3', null, '사용자 프로필'));

      const list = createElement('dl', 'profile-details');
      const entries = {
        성별: profile.gender,
        나이: profile.age,
        직군: profile.industry,
        역할: profile.role,
        시즌: profile.season,
        예산: profile.budget,
      };

      Object.entries(entries).forEach(([term, value]) => {
        const dt = createElement('dt', null, term);
        const dd = createElement('dd', null, safe(value));
        list.appendChild(dt);
        list.appendChild(dd);
      });

      if (Array.isArray(profile.style_preference) && profile.style_preference.length) {
        const dt = createElement('dt', null, '스타일');
        const dd = createElement('dd');
        const row = createElement('div', 'chip-row');
        profile.style_preference.forEach((tag) => {
          row.appendChild(createElement('span', 'chip blue', tag));
        });
        dd.appendChild(row);
        list.appendChild(dt);
        list.appendChild(dd);
      }

      section.appendChild(list);
      return section;
    }

    function renderItems(items) {
      if (!Array.isArray(items) || !items.length) return null;
      const list = createElement('ul', 'list');
      items.forEach((item) => {
        const li = createElement('li');
        li.appendChild(createElement('span', 'label', safe(item.category)));
        li.appendChild(createElement('span', null, safe(item.name)));
        if (item.color) li.appendChild(createElement('span', 'muted', `(${item.color})`));
        list.appendChild(li);
      });
      return list;
    }

    function renderTags(tags) {
      if (!Array.isArray(tags) || !tags.length) return null;
      const row = createElement('div', 'chip-row');
      tags.forEach((tag) => row.appendChild(createElement('span', 'chip', tag)));
      return row;
    }

    function renderColors(colors) {
      if (!Array.isArray(colors) || !colors.length) return null;
      const row = createElement('div', 'color-row');
      colors.forEach((color) => {
        const swatch = createElement('div', 'swatch');
        const chip = createElement('span');
        chip.style.backgroundColor = color;
        swatch.appendChild(chip);
        swatch.appendChild(createElement('span', null, color));
        row.appendChild(swatch);
      });
      return row;
    }

    function renderList(items, title) {
      if (!Array.isArray(items) || !items.length) return null;
      const section = createElement('div');
      if (title) section.appendChild(createElement('h4', null, title));
      const list = createElement('ul', 'list');
      items.forEach((entry) => list.appendChild(createElement('li', null, entry)));
      section.appendChild(list);
      return section;
    }

    function renderPerfumes(perfumes) {
      if (!Array.isArray(perfumes) || !perfumes.length) return null;
      const grid = createElement('div', 'perfume-grid');

      perfumes.forEach((perfume) => {
        const card = createElement('article', 'perfume');
        const titleRow = createElement('div', 'chip-row');
        titleRow.style.justifyContent = 'space-between';
        const title = createElement('h4', null, safe(perfume.name, '향수'));
        title.style.margin = '0';
        titleRow.appendChild(title);
        if (typeof perfume.score === 'number') {
          titleRow.appendChild(createElement('span', 'chip green', `Score ${perfume.score.toFixed(2)}`));
        }
        card.appendChild(titleRow);

        const meta = createElement('ul', 'meta');
        const metaEntries = [
          ['브랜드', perfume.brand],
          ['향조', Array.isArray(perfume.accords) ? perfume.accords.join(', ') : perfume.accords],
          ['노트', Array.isArray(perfume.notes) ? perfume.notes.join(', ') : perfume.notes],
          ['확산', perfume.projection],
          ['지속력', perfume.longevity],
        ];

        metaEntries.forEach(([label, value]) => {
          if (!value && value !== 0) return;
          const li = createElement('li');
          li.appendChild(createElement('span', 'label', label));
          li.appendChild(createElement('span', null, value));
          meta.appendChild(li);
        });

        if (Array.isArray(perfume.seasonality) && perfume.seasonality.length) {
          const li = createElement('li');
          li.appendChild(createElement('span', 'label', '시즌'));
          li.appendChild(createElement('span', null, perfume.seasonality.join(', ')));
          meta.appendChild(li);
        }

        if (meta.childElementCount) card.appendChild(meta);

        const why = renderList(perfume.why_match, '추천 이유');
        if (why) card.appendChild(why);

        grid.appendChild(card);
      });

      return grid;
    }

    function renderRecommendation(rec, index) {
      const section = createElement('article', 'recommendation');
      const header = createElement('div', 'chip-row');
      header.style.justifyContent = 'space-between';
      const title = createElement('h3', null, safe(rec.outfit?.title, `추천 ${index + 1}`));
      title.style.margin = '0';
      header.appendChild(title);
      if (typeof rec.score === 'number') {
        header.appendChild(createElement('span', 'chip green', `Score ${rec.score.toFixed(2)}`));
      }
      section.appendChild(header);

      if (rec.outfit?.hook_line) {
        section.appendChild(createElement('p', null, rec.outfit.hook_line));
      }

      if (rec.outfit?.dress_code) {
        section.appendChild(createElement('span', 'chip', rec.outfit.dress_code));
      }

      const items = renderItems(rec.outfit?.items);
      if (items) {
        const wrapper = createElement('div');
        wrapper.appendChild(createElement('h4', null, '아이템 구성'));
        wrapper.appendChild(items);
        section.appendChild(wrapper);
      }

      const tags = renderTags(rec.outfit?.style_tags);
      if (tags) {
        const wrapper = createElement('div');
        wrapper.appendChild(createElement('h4', null, '스타일 태그'));
        wrapper.appendChild(tags);
        section.appendChild(wrapper);
      }

      const colors = renderColors(rec.outfit?.color_palette);
      if (colors) {
        const wrapper = createElement('div');
        wrapper.appendChild(createElement('h4', null, '컬러 팔레트'));
        wrapper.appendChild(colors);
        section.appendChild(wrapper);
      }

      const why = renderList(rec.outfit?.why, '추천 이유');
      if (why) section.appendChild(why);

      const perfumes = renderPerfumes(rec.perfumes);
      if (perfumes) {
        const wrapper = createElement('div');
        wrapper.appendChild(createElement('h4', null, '어울리는 향수'));
        wrapper.appendChild(perfumes);
        section.appendChild(wrapper);
      }

      return section;
    }

    function renderStructuredResponse(parsed) {
      responseStructured.innerHTML = '';

      if (!parsed) {
        responseStructured.appendChild(createElement('p', 'placeholder', '응답을 파싱하지 못했습니다.')); 
        return;
      }

      const profile = renderProfile(parsed.profile_echo);
      if (profile) responseStructured.appendChild(profile);

      if (Array.isArray(parsed.recommendations) && parsed.recommendations.length) {
        parsed.recommendations.forEach((rec, index) => {
          responseStructured.appendChild(renderRecommendation(rec, index));
        });
      } else {
        responseStructured.appendChild(createElement('div', 'placeholder', '추천 결과가 없습니다.'));
      }

      if (parsed.pagination) {
        responseStructured.appendChild(
          createElement('p', 'muted', `요청 ${parsed.pagination.requested}개 중 ${parsed.pagination.returned}개 반환`)
        );
      }
    }

    async function submitForm(event) {
      event.preventDefault();
      statusEl.className = 'status';
      statusEl.textContent = '요청을 전송하는 중입니다...';
      responseStructured.innerHTML = '';
      responseStructured.appendChild(createElement('p', 'placeholder', '응답을 기다리는 중입니다...'));
      responseJson.textContent = '응답을 기다리는 중입니다...';

      const payload = {
        user_profile: {
          gender: form.gender.value,
          age: Number(form.age.value),
          occupation: {
            industry: form.industry.value,
            role: form.role.value,
          },
          style_preference: parseStylePreference(form.style_preference.value),
        },
        options: {
          season: form.season.value === 'null' ? null : form.season.value,
          budget: form.budget.value === 'null' ? null : form.budget.value,
          need_count: Number(form.need_count.value),
        },
      };

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (!response.ok || data.error || data.detail) {
          throw new Error(data.error || data.detail || '요청 실패');
        }

        statusEl.className = 'status success';
        statusEl.textContent = '응답을 성공적으로 받았습니다.';

        const parsed = data.parsed || null;
        renderStructuredResponse(parsed);
        responseJson.textContent = parsed
          ? JSON.stringify(parsed, null, 2)
          : data.response || '파싱 가능한 JSON이 없습니다.';
      } catch (error) {
        statusEl.className = 'status error';
        statusEl.textContent = error.message;
        responseStructured.innerHTML = '';
        responseStructured.appendChild(createElement('p', 'placeholder', error.message));
        responseJson.textContent = error.message;
        console.error(error);
      }
    }

    function fillExample() {
      form.gender.value = examplePayload.user_profile.gender;
      form.age.value = examplePayload.user_profile.age;
      form.industry.value = examplePayload.user_profile.occupation.industry;
      form.role.value = examplePayload.user_profile.occupation.role;
      form.style_preference.value = examplePayload.user_profile.style_preference.join(', ');
      form.season.value = examplePayload.options.season ?? 'null';
      form.budget.value = examplePayload.options.budget ?? 'null';
      form.need_count.value = examplePayload.options.need_count;
      statusEl.textContent = '';
      responseStructured.innerHTML = '';
      responseStructured.appendChild(createElement('p', 'placeholder', '모델 응답이 준비되면 이 영역에 카드가 표시됩니다.'));
      responseJson.textContent = '모델 응답이 준비되면 이곳에 JSON이 표시됩니다.';
    }

    function resetForm() {
      form.reset();
      statusEl.textContent = '';
      responseStructured.innerHTML = '';
      responseStructured.appendChild(createElement('p', 'placeholder', '모델 응답이 준비되면 이 영역에 카드가 표시됩니다.'));
      responseJson.textContent = '모델 응답이 준비되면 이곳에 JSON이 표시됩니다.';
    }

    form.addEventListener('submit', submitForm);
    prefillBtn.addEventListener('click', fillExample);
    resetBtn.addEventListener('click', resetForm);
  </script>
</body>
</html>
